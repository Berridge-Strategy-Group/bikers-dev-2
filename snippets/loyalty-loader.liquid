<script>
/* Global, ES5-safe loyalty loader */
(function () {
  var state = { data: null, loading: false, error: null, last: 0 };
  var subs = [];

  function notify(){
    for (var i = 0; i < subs.length; i++){
      try { subs[i](state.data, state); } catch (e) {}
    }
  }
  function subscribe(fn){
    subs.push(fn);
    if (state.data) { try { fn(state.data, state); } catch (e) {} }
    return function(){ var i = subs.indexOf(fn); if (i > -1) subs.splice(i, 1); };
  }

  function get(opts){
    opts = opts || {};
    var force = !!opts.force;
    var now = Date.now();
    if (!force && state.data && (now - state.last) < 30000) {
      return Promise.resolve(state.data);
    }

    state.loading = true; notify();

    var qs = new URLSearchParams(window.location.search);
    var extra = qs.get('_test_cid') ? '&_test_cid=' + encodeURIComponent(qs.get('_test_cid')) : '';
    var url = '/apps/loyalty/customer?ngrok-skip-browser-warning=1' + extra;

    return fetch(url, {
      headers: { 'Accept': 'application/json', 'X-React-Router-Data': '1' },
      credentials: 'same-origin'
    })
    .then(function(r){ return r.json(); })
    .then(function(json){
      state.data = json; state.error = null; state.last = now; notify();
      return json;
    })
    .catch(function(e){ state.error = e; notify(); throw e; })
    .then(function(v){ state.loading = false; return v; }, function(e){ state.loading = false; throw e; });
  }

  // Kick off once
  get();

  // Refresh when a section is reloaded or reordered in the editor
  document.addEventListener('shopify:section:load', function(){ get({ force:true }); });
  document.addEventListener('shopify:section:reorder', function(){ get({ force:true }); });

  // Expose globally
  window.__LOYALTY__ = { get: get, subscribe: subscribe, _state: state };
})();
</script>
